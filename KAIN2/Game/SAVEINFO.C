#include "CORE.H"
#include "SAVEINFO.H"
#include "MEMPACK.H"
#include "PSX/MAIN.H"
#include "GAMELOOP.H"
#include "MCARD/MEMCARD.H"
#include "DEBUG.H"
#include "SAVEINFO.H"
#include "STREAM.H"
#include "STRMLOAD.H"
#include "EVENT.H"

struct _GlobalSaveTracker* GlobalSave;
struct SavedBasic* bufferSavedIntroArray[64];
long numbufferedIntros; // offset 0x800CF8AC
long SaveArraySize[10] = { 0, 40, 16, 8, 834, 4, 120, 32, 12, 10 };

// autogenerated function stub: 
// void /*$ra*/ SAVE_GetInstanceRotation(struct _Instance *instance /*$s0*/, struct _SmallRotation *vector /*$s1*/)
void SAVE_GetInstanceRotation(struct _Instance *instance, struct _SmallRotation *vector)
{ // line 103, offset 0x800b5560
	/* begin block 1 */
		// Start line: 104
		// Start offset: 0x800B5560
		// Variables:
			struct evPositionData *rotation; // $v1
	/* end block 1 */
	// End offset: 0x800B55D4
	// End Line: 121

	/* begin block 2 */
		// Start line: 191
	/* end block 2 */
	// End Line: 192

	/* begin block 3 */
		// Start line: 206
	/* end block 3 */
	// End Line: 207
			UNIMPLEMENTED();
}

void SAVE_ClearMemory(struct GameTracker *gameTracker)
{
	char *buffer;

	buffer = savedInfoTracker.MemoryCardBuffer;

	savedInfoTracker.InfoStart = &buffer[the_header_size];
	savedInfoTracker.InfoEnd = &buffer[the_header_size];
	savedInfoTracker.EndOfMemory = &buffer[24576];

	memset(&savedInfoTracker.MemoryCardBuffer[the_header_size], 0, the_header_size);

	numbufferedIntros = 0;

	memset(bufferSavedIntroArray, 0, sizeof(bufferSavedIntroArray));

	GlobalSave = (struct _GlobalSaveTracker*)SAVE_GetSavedBlock(6, 0);
	GlobalSave->CurrentBirthID = 8192;
	GlobalSave->humanOpinionOfRaziel = 0;


	SAVE_GetSavedBlock(4, 0);
}

void SAVE_Init(struct GameTracker *gt)
{
	void *buffer;

	buffer = MEMPACK_Malloc(24576, 18);

	if (DoMainMenu != 0)
	{
		gt->memcard = &gMemcard;
		the_header_size = memcard_initialize(&gMemcard, gt, 3, buffer, 24576);
	}
	else
	{
		gt->memcard = NULL;
	}

	savedInfoTracker.MemoryCardBuffer = (char*)buffer;
	SAVE_ClearMemory(gt);
}

void* SAVE_GetSavedBlock(long saveType, long extraSize)
{	
	struct SavedBasic *savedInfo;
	long sizeOfSave;
	long done;

	savedInfo = NULL;

	if(saveType >= 10)
	{
		DEBUG_FatalError("illegal save type %d\n", saveType);
	}

	sizeOfSave = ((((SaveArraySize[saveType] + extraSize) + 3) >> 2) << 2);
	done = 0;
	
	if (sizeOfSave >= 1021)
	{
		DEBUG_FatalError("save %d is too big! (type %d)\n", sizeOfSave, saveType);
	}

	do
	{
		if (savedInfoTracker.InfoEnd + sizeOfSave < savedInfoTracker.EndOfMemory)
		{
			savedInfo = (struct SavedBasic*)savedInfoTracker.InfoEnd;

			savedInfoTracker.InfoEnd[0] = saveType;
			savedInfo->shiftedSaveSize = sizeOfSave >> 2;
			savedInfoTracker.InfoEnd += sizeOfSave;
			done = 1;
			break;
		}
		else
		{
			if (SAVE_PurgeAMemoryBlock() == 0)
			{
				done = 1;
				DEBUG_FatalError("ran out of saved memory. needed %d, used %d. increase from % d\n", sizeOfSave, savedInfoTracker.EndOfMemory - savedInfoTracker.InfoEnd, 24576);
			}
		}
	} while (done == 0);

	return savedInfo;
}


// autogenerated function stub: 
// long /*$ra*/ SAVE_PurgeAMemoryBlock()
long SAVE_PurgeAMemoryBlock()
{ // line 237, offset 0x800b5808
	/* begin block 1 */
		// Start line: 238
		// Start offset: 0x800B5808
		// Variables:
			struct SavedBasic *curSave; // $a0
			long result; // $a1
	/* end block 1 */
	// End offset: 0x800B5898
	// End Line: 259

	/* begin block 2 */
		// Start line: 488
	/* end block 2 */
	// End Line: 489
			UNIMPLEMENTED();
	return 0;
}


// autogenerated function stub: 
// long /*$ra*/ SAVE_SaveableInstance(struct _Instance *instance /*$a0*/)
long SAVE_SaveableInstance(struct _Instance *instance)
{ // line 265, offset 0x800b58a8
	/* begin block 1 */
		// Start line: 267
		// Start offset: 0x800B58A8
		// Variables:
			long result; // $a1
	/* end block 1 */
	// End offset: 0x800B599C
	// End Line: 320

	/* begin block 2 */
		// Start line: 551
	/* end block 2 */
	// End Line: 552

	/* begin block 3 */
		// Start line: 552
	/* end block 3 */
	// End Line: 553

	/* begin block 4 */
		// Start line: 554
	/* end block 4 */
	// End Line: 555
			UNIMPLEMENTED();
	return 0;
}


// autogenerated function stub: 
// struct _SavedIntro * /*$ra*/ SAVE_UpdateSavedIntro(struct _Instance *instance /*$s1*/, struct Level *level /*$a1*/, struct _SavedIntro *savedIntro /*$s0*/, struct evControlSaveDataData *extraData /*$s2*/)
struct _SavedIntro* SAVE_UpdateSavedIntro(struct _Instance *instance, struct Level *level, struct _SavedIntro *savedIntro, struct evControlSaveDataData *extraData)
{ // line 471, offset 0x800b59a4
	/* begin block 1 */
		// Start line: 472
		// Start offset: 0x800B59A4
		// Variables:
			_Position *levelOffset; // $t1

		/* begin block 1.1 */
			// Start line: 483
			// Start offset: 0x800B59D4
			// Variables:
				short _x0; // $v0
				short _y0; // $a2
				short _z0; // $v1
				short _x1; // $a3
				short _y1; // $t0
				short _z1; // $t1
				_Position *_v; // $v0
				_Position *_v0; // $v1
		/* end block 1.1 */
		// End offset: 0x800B59D4
		// End Line: 483
	/* end block 1 */
	// End offset: 0x800B5A94
	// End Line: 510

	/* begin block 2 */
		// Start line: 942
	/* end block 2 */
	// End Line: 943
				UNIMPLEMENTED();
	return null;
}


// autogenerated function stub: 
// struct _SavedIntroWithIntro * /*$ra*/ SAVE_UpdateSavedIntroWithIntro(struct _Instance *instance /*$s1*/, struct Level *level /*$a1*/, struct _SavedIntroWithIntro *savedIntro /*$s0*/, struct evControlSaveDataData *extraData /*$s2*/)
struct _SavedIntroWithIntro * SAVE_UpdateSavedIntroWithIntro(struct _Instance *instance, struct Level *level, struct _SavedIntroWithIntro *savedIntro, struct evControlSaveDataData *extraData)
{ // line 513, offset 0x800b5ab0
	/* begin block 1 */
		// Start line: 514
		// Start offset: 0x800B5AB0
		// Variables:
			_Position *levelOffset; // $t1

		/* begin block 1.1 */
			// Start line: 525
			// Start offset: 0x800B5AF0
			// Variables:
				short _x0; // $v0
				short _y0; // $a2
				short _z0; // $v1
				short _x1; // $a3
				short _y1; // $t0
				short _z1; // $t1
				_Position *_v; // $v0
				_Position *_v0; // $v1
		/* end block 1.1 */
		// End offset: 0x800B5AF0
		// End Line: 525
	/* end block 1 */
	// End offset: 0x800B5BCC
	// End Line: 553

	/* begin block 2 */
		// Start line: 916
	/* end block 2 */
	// End Line: 917
				UNIMPLEMENTED();
	return null;
}


// autogenerated function stub: 
// struct SavedBasic * /*$ra*/ SAVE_GetSavedEvent(long areaID /*$a0*/, long eventNumber /*$a1*/)
struct SavedBasic * SAVE_GetSavedEvent(long areaID, long eventNumber)
{ // line 556, offset 0x800b5be8
	/* begin block 1 */
		// Start line: 558
		// Start offset: 0x800B5BE8
		// Variables:
			struct SavedBasic *curSave; // $v1
	/* end block 1 */
	// End offset: 0x800B5C88
	// End Line: 577

	/* begin block 2 */
		// Start line: 1022
	/* end block 2 */
	// End Line: 1023

	/* begin block 3 */
		// Start line: 1023
	/* end block 3 */
	// End Line: 1024

	/* begin block 4 */
		// Start line: 1025
	/* end block 4 */
	// End Line: 1026
			UNIMPLEMENTED();
	return null;
}

void SAVE_DeleteSavedEvent(long areaID, long eventNumber)
{
	struct SavedBasic* savedEvent;

	savedEvent = SAVE_GetSavedEvent(areaID, eventNumber);

	if (savedEvent != NULL)
	{
		SAVE_DeleteBlock(savedEvent);
	}
}

struct SavedBasic* SAVE_GetSavedNextEvent(long areaID, struct SavedBasic* curSave)//Matching - 96.59%
{
	if (curSave == NULL)
	{
		curSave = (struct SavedBasic*)savedInfoTracker.InfoStart;
	}
	else
	{
		curSave = &curSave[curSave->shiftedSaveSize * 2];
	}

	while ((uintptr_t)curSave < (uintptr_t)savedInfoTracker.InfoEnd)
	{
		if (curSave->savedID == 2 && ((struct SavedEvent*)curSave)->areaID == areaID)
		{
			return curSave;
		}

		if (curSave->savedID == 9 && ((struct SavedEvent*)curSave)->areaID != areaID)
		{
			return curSave;
		}

		curSave += curSave->shiftedSaveSize * 2;
	}
	return 0;
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_BufferIntro(struct SavedBasic *savedIntro /*$a0*/)
void SAVE_BufferIntro(struct SavedBasic *savedIntro)
{ // line 619, offset 0x800b5d64
	/* begin block 1 */
		// Start line: 621
		// Start offset: 0x800B5D64
		// Variables:
			long i; // $a1
	/* end block 1 */
	// End offset: 0x800B5DDC
	// End Line: 655

	/* begin block 2 */
		// Start line: 1148
	/* end block 2 */
	// End Line: 1149

	/* begin block 3 */
		// Start line: 1149
	/* end block 3 */
	// End Line: 1150

	/* begin block 4 */
		// Start line: 1151
	/* end block 4 */
	// End Line: 1152
			UNIMPLEMENTED();
}

void SAVE_IntroduceBufferIntros()
{
	long i;
	struct _StreamUnit* streamUnit;
	int deleted;

	for (i = 0; numbufferedIntros != 0; i++)
	{
		if (i < 64)
		{
			if (bufferSavedIntroArray[i] != NULL)
			{
				if (bufferSavedIntroArray[i]->savedID == 1)
				{
					streamUnit = STREAM_GetStreamUnitWithID(((struct _SavedIntro*)bufferSavedIntroArray[i])->streamUnitID);

					if (streamUnit != NULL)
					{
						if (INSTANCE_IntroduceSavedInstance((struct _SavedIntro*)bufferSavedIntroArray[i], streamUnit, &deleted) != NULL)
						{
							bufferSavedIntroArray[i] = NULL;
							numbufferedIntros--;
						}
					}
					else
					{
						bufferSavedIntroArray[i] = NULL;
						numbufferedIntros--;
					}
				}
				else
				{
					streamUnit = STREAM_GetStreamUnitWithID(((struct _SavedIntroWithIntro*)bufferSavedIntroArray[i])->birthUnitID);

					if (streamUnit != NULL)
					{
						if (INSTANCE_IntroduceSavedInstanceWithIntro(((struct _SavedIntroWithIntro*)bufferSavedIntroArray[i]), streamUnit, &deleted) != NULL)
						{
							bufferSavedIntroArray[i] = NULL;
							numbufferedIntros--;
						}
					}
					else
					{
						bufferSavedIntroArray[i] = NULL;
						numbufferedIntros--;
					}
				}
			}
		}
	}
}

void SAVE_IntroForStreamID(struct _StreamUnit* streamUnit)
{
	struct SavedBasic* saveIntro;
	long streamID;
	int deleted;
	
	saveIntro = (struct SavedBasic*)savedInfoTracker.InfoStart;

	streamID = streamUnit->StreamUnitID;

	while ((char*)saveIntro < savedInfoTracker.InfoEnd)
	{
		deleted = 0;

		if (saveIntro->savedID == 1 && ((struct _SavedIntro*)saveIntro)->streamUnitID == streamID)
		{
			INSTANCE_IntroduceSavedInstance((struct _SavedIntro*)saveIntro, streamUnit, &deleted);
		}
		else if(saveIntro->savedID == 7 && ((struct _SavedIntroWithIntro*)saveIntro)->birthUnitID == streamID)
		{
			INSTANCE_IntroduceSavedInstanceWithIntro((struct _SavedIntroWithIntro*)saveIntro, streamUnit, &deleted);
		}

		if (deleted == 0)
		{
			saveIntro = (struct SavedBasic*)((char*)saveIntro + (saveIntro->shiftedSaveSize << 2));
		}
	}
}

long SAVE_HasSavedIntro(struct Intro* intro, long currentStreamID)//Matching - 99.72%
{
	struct _SavedIntro* saveIntro;
	long result;

	saveIntro = (struct _SavedIntro*)savedInfoTracker.InfoStart;
	result = 0;

	while ((uintptr_t)saveIntro < (uintptr_t)savedInfoTracker.InfoEnd)
	{
		if (saveIntro->savedID == 1 && saveIntro->introUniqueID == intro->UniqueID ||
			saveIntro->savedID == 7 && *(short*)&saveIntro->name[4] == intro->UniqueID)
		{
			result = 1;
			break;
		}

		saveIntro = (struct _SavedIntro*)(((char*)saveIntro) + saveIntro->shiftedSaveSize * 4);
	}

	return result;
}

struct SavedLevel* SAVE_HasSavedLevel(long areaID)//Matching - 91.20%
{
	struct SavedLevel* savedLevel;

	savedLevel = (struct SavedLevel*)savedInfoTracker.InfoStart;

	while ((char*)savedLevel < savedInfoTracker.InfoEnd)
	{
		if (savedLevel->savedID == 3)
		{
			if (savedLevel->areaID == areaID)
			{
				return savedLevel;
			}
		}
		savedLevel = (struct SavedLevel*)((char*)savedLevel + 4 * savedLevel->shiftedSaveSize);
	}

	return 0;
}

void SAVE_UpdateLevelWithSave(struct _StreamUnit* streamUnit)//Matching - 99.70%
{
	long Zoffset;
	struct ActualSavedLevel* savedLevel;
	struct _Terrain* terrain;
	long i;
	struct BSPTree* bspTree;

	Zoffset = streamUnit->level->terrain->BSPTreeArray->globalOffset.z;

	savedLevel = (struct ActualSavedLevel*)SAVE_HasSavedLevel(streamUnit->StreamUnitID);

	if (savedLevel != NULL)
	{
		terrain = streamUnit->level->terrain;

		for (i = 0; i < savedLevel->numberBSPTreesSaved; i++)
		{
			bspTree = &terrain->BSPTreeArray[savedLevel->bspTreeArray[i].bspIndex];

			bspTree->localOffset = savedLevel->bspTreeArray[i].localOffset;

			bspTree->flags = ((unsigned short)bspTree->flags << 16 >> 24 << 8);

			bspTree->flags |= savedLevel->bspTreeArray[i].importantFlagsSaved;

			bspTree->globalOffset.x += bspTree->localOffset.x;
			bspTree->globalOffset.y += bspTree->localOffset.y;
			bspTree->globalOffset.z += bspTree->localOffset.z;
		}

		if (savedLevel->waterZ != -32767 && savedLevel->waterZ != 32767)
		{
			streamUnit->level->waterZLevel = savedLevel->waterZ + Zoffset;
		}
		else
		{
			streamUnit->level->waterZLevel = savedLevel->waterZ;
		}

		terrain->UnitChangeFlags |= 0x3;
	}
}


// autogenerated function stub: 
// struct SavedLevel * /*$ra*/ SAVE_CreatedSavedLevel(long areaID /*$s3*/, struct Level *level /*$s2*/)
struct SavedLevel * SAVE_CreatedSavedLevel(long areaID, struct Level *level)
{ // line 860, offset 0x800b61dc
	/* begin block 1 */
		// Start line: 861
		// Start offset: 0x800B61DC
		// Variables:
			struct SavedLevel *savedLevel; // $s0
			struct ActualSavedLevel *slevel; // $a0
			long doSave; // $a1
			long i; // $a1
			struct BSPTree *bspTree; // $v1
			long Zoffset; // $s4

		/* begin block 1.1 */
			// Start line: 881
			// Start offset: 0x800B623C
			// Variables:
				long numBSPTrees; // $s1

			/* begin block 1.1.1 */
				// Start line: 886
				// Start offset: 0x800B6258
			/* end block 1.1.1 */
			// End offset: 0x800B6350
			// End Line: 931
		/* end block 1.1 */
		// End offset: 0x800B6350
		// End Line: 932
	/* end block 1 */
	// End offset: 0x800B6374
	// End Line: 943

	/* begin block 2 */
		// Start line: 1738
	/* end block 2 */
	// End Line: 1739
				UNIMPLEMENTED();
	return null;
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_DeleteBlock(struct SavedBasic *savedBlock /*$a0*/)
void SAVE_DeleteBlock(struct SavedBasic *savedBlock)
{ // line 947, offset 0x800b6398
	/* begin block 1 */
		// Start line: 948
		// Start offset: 0x800B6398
		// Variables:
			long size; // $s0
			char *nextBlock; // $a1

		/* begin block 1.1 */
			// Start line: 960
			// Start offset: 0x800B63C0
			// Variables:
				int i; // $a3
		/* end block 1.1 */
		// End offset: 0x800B63FC
		// End Line: 978
	/* end block 1 */
	// End offset: 0x800B63FC
	// End Line: 980

	/* begin block 2 */
		// Start line: 1932
	/* end block 2 */
	// End Line: 1933
				UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_Instance(struct _Instance *instance /*$s1*/, struct Level *level /*$s3*/)
void SAVE_Instance(struct _Instance *instance, struct Level *level)
{ // line 991, offset 0x800b6424
	/* begin block 1 */
		// Start line: 992
		// Start offset: 0x800B6424
		// Variables:
			struct _SavedIntro *savedIntro; // $v0
			struct evControlSaveDataData *extraData; // $s0
			long extraSize; // $s2
			long saveType; // $v1

		/* begin block 1.1 */
			// Start line: 1003
			// Start offset: 0x800B646C
			// Variables:
				struct SavedIntroSmall *savedSmallIntro; // $a0

			/* begin block 1.1.1 */
				// Start line: 1010
				// Start offset: 0x800B648C
			/* end block 1.1.1 */
			// End offset: 0x800B64A4
			// End Line: 1016
		/* end block 1.1 */
		// End offset: 0x800B64A4
		// End Line: 1016

		/* begin block 1.2 */
			// Start line: 1048
			// Start offset: 0x800B6524
			// Variables:
				struct _SavedIntroWithIntro *savedIntroWithIntro; // $v0
		/* end block 1.2 */
		// End offset: 0x800B6558
		// End Line: 1062

		/* begin block 1.3 */
			// Start line: 1069
			// Start offset: 0x800B6578
			// Variables:
				struct SavedIntroSpline *savedIntroSpline; // $s0

			/* begin block 1.3.1 */
				// Start line: 1076
				// Start offset: 0x800B6598
				// Variables:
					struct MultiSpline *multi; // $a1
			/* end block 1.3.1 */
			// End offset: 0x800B663C
			// End Line: 1096
		/* end block 1.3 */
		// End offset: 0x800B663C
		// End Line: 1097
	/* end block 1 */
	// End offset: 0x800B663C
	// End Line: 1102

	/* begin block 2 */
		// Start line: 2041
	/* end block 2 */
	// End Line: 2042
					UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_DeleteInstance(struct _Instance *instance /*$a2*/)
void SAVE_DeleteInstance(struct _Instance *instance)
{ // line 1104, offset 0x800b6658
	/* begin block 1 */
		// Start line: 1105
		// Start offset: 0x800B6658
		// Variables:
			struct SavedBasic *saveIntro; // $a0
	/* end block 1 */
	// End offset: 0x800B6718
	// End Line: 1132

	/* begin block 2 */
		// Start line: 2270
	/* end block 2 */
	// End Line: 2271
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_SetDeadDeadBit(int uniqueID /*$a0*/, long set /*$a1*/)
void SAVE_SetDeadDeadBit(int uniqueID, long set)
{ // line 1134, offset 0x800b6728
	/* begin block 1 */
		// Start line: 1136
		// Start offset: 0x800B6728
		// Variables:
			struct _SavedIntro *saveIntro; // $a2
			struct SavedDeadDeadBits *deadDeadBits; // $v1

		/* begin block 1.1 */
			// Start line: 1155
			// Start offset: 0x800B6784
			// Variables:
				int deadByte; // $a2
				int deadBit; // $a0
		/* end block 1.1 */
		// End offset: 0x800B67E4
		// End Line: 1177
	/* end block 1 */
	// End offset: 0x800B67E4
	// End Line: 1180

	/* begin block 2 */
		// Start line: 2336
	/* end block 2 */
	// End Line: 2337

	/* begin block 3 */
		// Start line: 2337
	/* end block 3 */
	// End Line: 2338

	/* begin block 4 */
		// Start line: 2340
	/* end block 4 */
	// End Line: 2341
				UNIMPLEMENTED();
}

void SAVE_RestoreGlobalSavePointer()//Matching - 99.09%
{
	struct SavedBasic* saveIntro;

	saveIntro = (struct SavedBasic*)savedInfoTracker.InfoStart;

	GlobalSave = NULL;

	while ((uintptr_t)saveIntro < (uintptr_t)savedInfoTracker.InfoEnd)
	{
		if (saveIntro->savedID == 6)
		{
			GlobalSave = (struct _GlobalSaveTracker*)saveIntro;

			return;
		}

		saveIntro = (struct SavedBasic*)(char*)(saveIntro + (2 * (unsigned char)saveIntro->shiftedSaveSize));
	}
}

long SAVE_IsUniqueIDDeadDead(long uniqueID)
{
	struct _SavedIntro* saveIntro;
	struct SavedDeadDeadBits* deadDeadBits;
	long result;
	int deadByte;
	int deadBit;

	deadDeadBits = NULL;

	result = 0;

	if (uniqueID >= 0x2000)
	{
		saveIntro = (struct _SavedIntro*)savedInfoTracker.InfoStart;

		while ((char*)saveIntro < savedInfoTracker.InfoEnd)
		{
			if (saveIntro->savedID == 4)
			{
				deadDeadBits = (struct SavedDeadDeadBits*)saveIntro;
				break;
			}

			saveIntro = (struct _SavedIntro*)((char*)saveIntro + (saveIntro->shiftedSaveSize << 2));
		}

		if (deadDeadBits != NULL)
		{
			deadByte = ((uniqueID < 0 ? uniqueID + 7 : uniqueID) >> 3);

			deadBit = (1 << (uniqueID & 0x7));

			if (deadByte < 832)
			{
				result = (unsigned)((deadDeadBits->deadDeadBits[deadByte] & deadBit) ^ deadBit) < 1;
			}
		}
	}

	return result;
}

long SAVE_IsIntroDeadDead(struct Intro* intro)
{
	return SAVE_IsUniqueIDDeadDead(intro->UniqueID);
}

void SAVE_DoInstanceDeadDead(struct _Instance* instance)
{
	SAVE_DeleteInstance(instance);

	SAVE_SetDeadDeadBit(instance->introUniqueID, 1);
}

void SAVE_MarkDeadDead(struct _Instance* instance)
{
	instance->flags |= 0x800000;
}

void SAVE_UndestroyInstance(struct _Instance* instance)
{
	SAVE_SetDeadDeadBit(instance->introUniqueID, 0);
}

struct SavedIntroSmall * SAVE_GetSavedSmallIntro(struct _Instance *instance)
{
	struct SavedBasic* curSave;

	curSave = (struct SavedBasic*)savedInfoTracker.InfoStart;
	
	while ((char*)curSave < savedInfoTracker.InfoEnd)
	{
		if (curSave->savedID == 2)
		{
			if (((struct SavedIntroSmall*)curSave)->introUniqueID == instance->introUniqueID)
			{
				return (struct SavedIntroSmall*)curSave;
			}
		}
		curSave = (struct SavedBasic*)((char*)curSave + (curSave->shiftedSaveSize << 2));
	}

	return NULL;
}

struct SavedIntroSpline* SAVE_GetIntroSpline(struct _Instance* instance)//Matching - 91.85%
{
	struct SavedBasic* curSave;

	curSave = (struct SavedBasic*)savedInfoTracker.InfoStart;
	while ((unsigned int)curSave < (unsigned int)savedInfoTracker.InfoEnd)
	{
		if (curSave->savedID == 8)
		{
			if (((struct SavedIntroSpline*)curSave)->introUniqueID == instance->introUniqueID)
				return (struct SavedIntroSpline*)curSave;
		}
		curSave = (struct SavedBasic*)(char*)curSave + 2 * (unsigned char)curSave->shiftedSaveSize;
	}

	return NULL;
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_UpdateGlobalSaveTracker()
void SAVE_UpdateGlobalSaveTracker()
{ 
#if 0
	ub_800B66DC:

	var_s0 = 0

		lw      $v1, -0x57C0($gp)
		lw      $v0, -0x400C($gp)
		addiu   $sp, -0x18
		sw      $ra, 0x10 + var_s0($sp)
		sw      $v0, 8($v1)
		addiu   $a3, $gp, -0x4088
		lw      $a0, 0($a3)
		lw      $a1, 4($a3)
		lw      $a2, 8($a3)
		sw      $a0, 0x60($v1)
		sw      $a1, 0x64($v1)
		sw      $a2, 0x68($v1)
		lw      $a0, 0xC($a3)
		lw      $a1, 0x10($a3)
		sw      $a0, 0x6C($v1)
		sw      $a1, 0x70($v1)
		lw      $v1, -0x57C0($gp)
		li      $v0, 0x5521
		jal     sub_8003160C
		sh      $v0, 6($v1)
		beqz    $v0, loc_800B6748
		nop
		lw      $v1, -0x57C0($gp)
		nop
		lhu     $v0, 4($v1)
		j       loc_800B675C
		ori     $v0, 2

		loc_800B6748:
	lw      $v1, -0x57C0($gp)
		nop
		lhu     $v0, 4($v1)
		nop
		andi    $v0, 0xFFFD

		loc_800B675C :
		sh      $v0, 4($v1)
		lw      $ra, 0x10 + var_s0($sp)
		nop
		jr      $ra
		addiu   $sp, 0x18
#endif
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_RestoreGlobalSaveTracker()
void SAVE_RestoreGlobalSaveTracker()
{ // line 1326, offset 0x800b6ae8
	/* begin block 1 */
		// Start line: 2740
	/* end block 1 */
	// End Line: 2741

	/* begin block 2 */
		// Start line: 2742
	/* end block 2 */
	// End Line: 2743
	UNIMPLEMENTED();
}

void SAVE_SaveEverythingInMemory()
{ 
	struct _Instance* instance;
	long i;
	struct _Instance* next;
	struct Level* level;
	
	instance = gameTrackerX.instanceList->first;
	next = NULL;

	while (instance != NULL)
	{
		next = instance->next;
		level = STREAM_GetLevelWithID(instance->currentStreamUnitID);

		if (level != NULL)
		{
			SAVE_Instance(instance, level);
		}

		instance = next;
		next = NULL;
	}

	for (i = 0; i < 16; i++)
	{
		if (StreamTracker.StreamList[i].used == 2)
		{
			EVENT_SaveEventsFromLevel(StreamTracker.StreamList[i].StreamUnitID, StreamTracker.StreamList[i].level);
			
			SAVE_CreatedSavedLevel(StreamTracker.StreamList[i].StreamUnitID, StreamTracker.StreamList[i].level);
		}
	}
}

void SAVE_SaveGame()
{
	while (STREAM_PollLoadQueue() == 0)
	{
	}

	SAVE_SaveEverythingInMemory();

	SAVE_UpdateGlobalSaveTracker();

	GlobalSave->sizeUsedInBlock = ((unsigned short*)&savedInfoTracker.InfoEnd)[0] - ((unsigned short*)&savedInfoTracker.InfoStart)[0];
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_RestoreGame()
void SAVE_RestoreGame()
{ // line 1406, offset 0x800b6cb8
	UNIMPLEMENTED();
}

void SAVE_DebugSaveGame()
{
}

void SAVE_LoadSaveGame()
{
	gameTrackerX.streamFlags |= 0x200000;

	GAMELOOP_RequestLevelChange("under", 1, &gameTrackerX);

	gameTrackerX.gameMode = 0;
}

long SAVE_SizeOfFreeSpace()
{
	return savedInfoTracker.EndOfMemory - savedInfoTracker.InfoEnd;
}
