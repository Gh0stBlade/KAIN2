#include "Game/CORE.H"
#include "SOUL.H"
#include "Game/STATE.H"

struct _MonsterFunctionTable SOUL_FunctionTable;

void SOUL_QueueHandler(struct _Instance* instance)  // Matching - 100%
{
	struct _MonsterVars* mv;
	struct __Event* message;
	mv = (struct _MonsterVars*)instance->extraData;
	while (message = DeMessageQueue(&mv->messageQueue), message != NULL)
	{
		if (message->ID == 0x100000D)
		{
			if (instance->currentMainState != 23)
			{
				MON_SwitchState(instance, (MonsterState)23);
			}
			continue;
		}
		MON_DefaultMessageHandler(instance, message);
	}
}

void SOUL_Physics(struct _Instance* instance, long time)  // Matching - 100%
{
	struct _MonsterVars* mv;
	int a;
	mv = (struct _MonsterVars*)instance->extraData;
	a = -4;
	if ((mv->ambushRange & 0x1F) < 16)
	{
		a = 4;
	}
	instance->zAccl += a;
	mv->ambushRange += 1;
	PhysicsMove(instance, &instance->position, time);
}


// autogenerated function stub: 
// void /*$ra*/ SOUL_Fade(struct _Instance *instance /*$s0*/)
void SOUL_Fade(struct _Instance *instance)
{ // line 120, offset 0x8008d7d0
	/* begin block 1 */
		// Start line: 121
		// Start offset: 0x8008D7D0
		// Variables:
			struct _MonsterVars *mv; // $s1
			unsigned long time; // $a0
	/* end block 1 */
	// End offset: 0x8008D870
	// End Line: 145

	/* begin block 2 */
		// Start line: 251
	/* end block 2 */
	// End Line: 252
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SOUL_MoveToDest(struct _Instance *instance /*$a3*/, long maxAccel /*$t0*/, long time /*$a2*/)
void SOUL_MoveToDest(struct _Instance *instance, long maxAccel, long time)
{ // line 147, offset 0x8008d884
	/* begin block 1 */
		// Start line: 148
		// Start offset: 0x8008D884
		// Variables:
			struct _MonsterVars *mv; // $a1
	/* end block 1 */
	// End offset: 0x8008D958
	// End Line: 158

	/* begin block 2 */
		// Start line: 305
	/* end block 2 */
	// End Line: 306
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SOUL_MovePastWall(struct _Instance *instance /*$s2*/, struct _Instance *sucker /*$a1*/)
void SOUL_MovePastWall(struct _Instance *instance, struct _Instance *sucker)
{ // line 162, offset 0x8008d974
	/* begin block 1 */
		// Start line: 163
		// Start offset: 0x8008D974
		// Variables:
			//struct _PCollideInfo pcollideInfo; // stack offset -88
			_Position newPos; // stack offset -40
			_Position oldPos; // stack offset -32
			_Position delta; // stack offset -24
			MATRIX *to; // $a0
			MATRIX *from; // $v1
			long tmp; // $v0

		/* begin block 1.1 */
			// Start line: 163
			// Start offset: 0x8008D974
			// Variables:
				short _y0; // $v0
				short _z0; // $a0
				short _y1; // $a1
				short _z1; // $a2
				_Position *_v; // $s0
				_Position *_v0; // $s1
				_Position *_v1; // $t0
		/* end block 1.1 */
		// End offset: 0x8008D974
		// End Line: 163

		/* begin block 1.2 */
			// Start line: 188
			// Start offset: 0x8008DA58
			// Variables:
				//short _x0; // $v0
				//short _y0; // $v1
				//short _z0; // $a2
				//short _x1; // $a3
				//short _y1; // $t1
				//short _z1; // $t0
				//_Position *_v1; // $t0
		/* end block 1.2 */
		// End offset: 0x8008DA58
		// End Line: 188
	/* end block 1 */
	// End offset: 0x8008DACC
	// End Line: 201

	/* begin block 2 */
		// Start line: 336
	/* end block 2 */
	// End Line: 337
				UNIMPLEMENTED();
}

void SOUL_Init(struct _Instance* instance)  // Matching - 100%
{
	struct _MonsterVars* mv;
	mv = (struct _MonsterVars*)instance->extraData;
	MON_DefaultInit(instance);
	mv->mvFlags |= 0x200000 | 0x880;
	instance->maxXVel = 0x258;
	instance->maxYVel = 0x258;
	instance->maxZVel = 0x258;
	instance->flags2 |= 0x20000;
	mv->ambushRange = 0;
	mv->lookAtPos = (_Position*)(MON_GetTime(instance) + 0x1964);
	if (instance->parent != NULL)
	{
		mv->soulID = instance->parent->introUniqueID;
	}
	if ((instance->flags & 2) == 0)
	{
		instance->flags2 |= 0x8000000;
		MON_SwitchState(instance, (MonsterState)2);
	}
}

void SOUL_CleanUp(struct _Instance* instance)
{
	MON_CleanUp(instance);
}

void SOUL_BirthEntry(struct _Instance* instance)//Matching - 99.76%
{
	struct _MonsterVars* mv;

	mv = (struct _MonsterVars*)instance->extraData;

	instance->maxXVel = 15;
	instance->maxYVel = 15;
	instance->maxZVel = 17;

	instance->zAccl = 0;

	instance->zVel = 0;

	instance->position.z += 120;

	mv->generalTimer = MON_GetTime(instance) + 1500;
}


// autogenerated function stub: 
// void /*$ra*/ SOUL_Birth(struct _Instance *instance /*$s1*/)
void SOUL_Birth(struct _Instance *instance)
{ // line 257, offset 0x8008dc1c
	/* begin block 1 */
		// Start line: 258
		// Start offset: 0x8008DC1C
		// Variables:
			struct _MonsterVars *mv; // $s0
	/* end block 1 */
	// End offset: 0x8008DC68
	// End Line: 269

	/* begin block 2 */
		// Start line: 564
	/* end block 2 */
	// End Line: 565
			UNIMPLEMENTED();
}

void SOUL_SoulSuckEntry(struct _Instance* instance)
{
	instance->maxXVel = 600;
	instance->maxYVel = 600;
	instance->maxZVel = 17;

	instance->flags &= ~0x800u;
}

long SOUL_CalcAccel(long delta, long vel, long magnitude)//Matching - 43.75%
{
	long rv;

	if (delta > 0)
	{
		if (vel < 0)
		{
			rv = (delta * 16) / magnitude;
		}
		else
		{
			rv = (delta * 5) / magnitude;
		}
	}
	else
	{
		if (vel > 0)
		{
			rv = (delta * 16) / magnitude;
		}
		else
		{
			rv = (delta * 5) / magnitude;
		}
	}

	return rv;
}


// autogenerated function stub: 
// void /*$ra*/ SOUL_SoulSuck(struct _Instance *instance /*$s2*/)
void SOUL_SoulSuck(struct _Instance *instance)
{ // line 313, offset 0x8008dcec
	/* begin block 1 */
		// Start line: 314
		// Start offset: 0x8008DCEC
		// Variables:
			struct _MonsterVars *mv; // $s3
			struct __Event *message; // $s0
			struct _Instance *sucker; // $s4
			struct _Instance *collidedWith; // $s6
			int collisionCnt; // $s5

		/* begin block 1.1 */
			// Start line: 330
			// Start offset: 0x8008DD98
			// Variables:
				long distance; // $s1
				struct evMonsterSoulSuckData *suckData; // $s0

			/* begin block 1.1.1 */
				// Start line: 357
				// Start offset: 0x8008DEBC
				// Variables:
					struct _SVector dir; // stack offset -48

				/* begin block 1.1.1.1 */
					// Start line: 368
					// Start offset: 0x8008DEF0
					// Variables:
						long animLen; // $s0
						long curTim; // $v0

					/* begin block 1.1.1.1.1 */
						// Start line: 379
						// Start offset: 0x8008DF88
						// Variables:
							short _x0; // $a3
							short _y0; // $a0
							short _z0; // $v1
							short _x1; // $v0
							short _y1; // $a2
							short _z1; // $a1
							struct _SVector *_v; // $s7
							_Position *_v0; // $v1
							_Position *_v1; // $a1
					/* end block 1.1.1.1.1 */
					// End offset: 0x8008DF88
					// End Line: 379
				/* end block 1.1.1.1 */
				// End offset: 0x8008E03C
				// End Line: 389
			/* end block 1.1.1 */
			// End offset: 0x8008E03C
			// End Line: 389
		/* end block 1.1 */
		// End offset: 0x8008E074
		// End Line: 398

		/* begin block 1.2 */
			// Start line: 452
			// Start offset: 0x8008E1E8
			// Variables:
				struct _Instance *body; // $v0
		/* end block 1.2 */
		// End offset: 0x8008E208
		// End Line: 456
	/* end block 1 */
	// End offset: 0x8008E264
	// End Line: 469

	/* begin block 2 */
		// Start line: 681
	/* end block 2 */
	// End Line: 682
				UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SOUL_WanderEntry(struct _Instance *instance /*$a0*/)
void SOUL_WanderEntry(struct _Instance *instance)
{ // line 474, offset 0x8008e294
	/* begin block 1 */
		// Start line: 475
		// Start offset: 0x8008E294
		// Variables:
			struct _MonsterVars *mv; // $a2
	/* end block 1 */
	// End offset: 0x8008E2F4
	// End Line: 487

	/* begin block 2 */
		// Start line: 1046
	/* end block 2 */
	// End Line: 1047
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SOUL_Wander(struct _Instance *instance /*$s0*/)
void SOUL_Wander(struct _Instance *instance)
{ // line 489, offset 0x8008e304
	/* begin block 1 */
		// Start line: 490
		// Start offset: 0x8008E304
		// Variables:
			struct _MonsterVars *mv; // $s1

		/* begin block 1.1 */
			// Start line: 502
			// Start offset: 0x8008E370
		/* end block 1.1 */
		// End offset: 0x8008E420
		// End Line: 515
	/* end block 1 */
	// End offset: 0x8008E478
	// End Line: 530

	/* begin block 2 */
		// Start line: 1076
	/* end block 2 */
	// End Line: 1077
			UNIMPLEMENTED();
}

void SOUL_FleeEntry(struct _Instance* instance)
{
	instance->maxXVel = 15;
	instance->maxYVel = 15;
	instance->maxZVel = 17;

	MON_FleeEntry(instance);
}


// autogenerated function stub: 
// void /*$ra*/ SOUL_Flee(struct _Instance *instance /*$s0*/)
void SOUL_Flee(struct _Instance *instance)
{ // line 543, offset 0x8008e4c4
	/* begin block 1 */
		// Start line: 544
		// Start offset: 0x8008E4C4
		// Variables:
			struct _MonsterVars *mv; // $v0

		/* begin block 1.1 */
			// Start line: 553
			// Start offset: 0x8008E500
			// Variables:
				struct _Instance *enemy; // $a0
				int dx; // $s1
				int dy; // $v0
		/* end block 1.1 */
		// End offset: 0x8008E5E4
		// End Line: 568
	/* end block 1 */
	// End offset: 0x8008E614
	// End Line: 574

	/* begin block 2 */
		// Start line: 1186
	/* end block 2 */
	// End Line: 1187
				UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SOUL_IdleEntry(struct _Instance *instance /*$a0*/)
void SOUL_IdleEntry(struct _Instance *instance)
{ // line 579, offset 0x8008e628
	/* begin block 1 */
		// Start line: 580
		// Start offset: 0x8008E628
		// Variables:
			struct _MonsterVars *mv; // $s1
	/* end block 1 */
	// End offset: 0x8008E628
	// End Line: 580

	/* begin block 2 */
		// Start line: 1261
	/* end block 2 */
	// End Line: 1262
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SOUL_Idle(struct _Instance *instance /*$s0*/)
void SOUL_Idle(struct _Instance *instance)
{ // line 587, offset 0x8008e6cc
	/* begin block 1 */
		// Start line: 588
		// Start offset: 0x8008E6CC
		// Variables:
			struct _MonsterVars *mv; // $s1
			long xAccl; // $a1
			long yAccl; // $a0
	/* end block 1 */
	// End offset: 0x8008E7B0
	// End Line: 623

	/* begin block 2 */
		// Start line: 1278
	/* end block 2 */
	// End Line: 1279
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SOUL_ReanimateEntry(struct _Instance *instance /*$s1*/)
void SOUL_ReanimateEntry(struct _Instance *instance)
{ // line 629, offset 0x8008e7cc
	/* begin block 1 */
		// Start line: 630
		// Start offset: 0x8008E7CC
		// Variables:
			struct _MonsterVars *mv; // $s0
			struct _Instance *body; // $v0
	/* end block 1 */
	// End offset: 0x8008E7CC
	// End Line: 630

	/* begin block 2 */
		// Start line: 1365
	/* end block 2 */
	// End Line: 1366
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SOUL_Reanimate(struct _Instance *instance /*$s1*/)
void SOUL_Reanimate(struct _Instance *instance)
{ // line 646, offset 0x8008e834
	/* begin block 1 */
		// Start line: 647
		// Start offset: 0x8008E834
		// Variables:
			struct _MonsterVars *mv; // $s0

		/* begin block 1.1 */
			// Start line: 659
			// Start offset: 0x8008E890
			// Variables:
				struct _Instance *body; // $v0
		/* end block 1.1 */
		// End offset: 0x8008E8B8
		// End Line: 663
	/* end block 1 */
	// End offset: 0x8008E8D8
	// End Line: 671

	/* begin block 2 */
		// Start line: 1401
	/* end block 2 */
	// End Line: 1402
				UNIMPLEMENTED();
}

void SOUL_Effect(struct _Instance* instance, struct evFXHitData* data)
{
}